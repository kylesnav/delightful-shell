#!/bin/bash
# smart-open — iTerm2 Semantic History handler
# Cmd+click on file paths in iTerm2 to open them intelligently:
#   Directories     → Finder
#   .html files     → Chrome
#   Code files      → VS Code (with line number support)
#   Images          → Preview
#   PDFs            → Preview
#   Everything else → default app (via `open`)
#
# Setup:
#   1. Copy to ~/.local/bin/smart-open and chmod +x
#   2. iTerm2 → Settings → Profiles → Advanced → Semantic History
#      → "Run command..." → /Users/YOU/.local/bin/smart-open \1 \2 \5
#
# iTerm2 substitutions: \1 = filename, \2 = line number, \5 = working dir

FILE="$1"
LINE="${2:-}"
WORKDIR="${3:-}"

# Resolve relative paths against working directory
if [[ ! -e "$FILE" ]] && [[ -n "$WORKDIR" ]]; then
  FILE="$WORKDIR/$1"
fi

# Still doesn't exist — bail silently
[[ ! -e "$FILE" ]] && exit 0

# Resolve to absolute path
FILE="$(cd "$(dirname "$FILE")" 2>/dev/null && pwd)/$(basename "$FILE")"

# Directories → Finder
if [[ -d "$FILE" ]]; then
  open "$FILE"
  exit 0
fi

# Route by extension
EXT="${FILE##*.}"
EXT="$(printf '%s' "$EXT" | tr '[:upper:]' '[:lower:]')"

# Code file extensions (checked via associative lookup for speed)
CODE_EXTS="|js|jsx|ts|tsx|mjs|cjs|json|jsonc|css|scss|sass|less|py|rb|rs|go|java|kt|swift|c|cpp|h|hpp|cs|sh|bash|zsh|fish|md|mdx|txt|yaml|yml|toml|ini|cfg|conf|xml|svg|sql|graphql|gql|vue|svelte|astro|lua|vim|el|clj|ex|exs|hs|ml|r|jl|"

# Extensionless code files
CODE_NAMES="|Dockerfile|Makefile|Justfile|Brewfile|Gemfile|Rakefile|Procfile|.gitignore|.gitattributes|.editorconfig|.env|CLAUDE.md|"

open_in_code() {
  if [[ -n "$LINE" ]]; then
    code --goto "$FILE:$LINE"
  else
    code "$FILE"
  fi
}

case "$EXT" in
  html|htm)
    open -a "Google Chrome" "$FILE"
    ;;
  png|jpg|jpeg|gif|webp|bmp|tiff|tif|ico|heic|heif)
    open -a "Preview" "$FILE"
    ;;
  pdf)
    open -a "Preview" "$FILE"
    ;;
  *)
    if [[ "$CODE_EXTS" == *"|${EXT}|"* ]]; then
      open_in_code
    elif [[ "$CODE_NAMES" == *"|$(basename "$FILE")|"* ]]; then
      open_in_code
    else
      open "$FILE"
    fi
    ;;
esac
